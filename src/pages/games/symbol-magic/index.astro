---
import BaseLayout from '../../../layouts/BaseLayout.astro';
---

<BaseLayout title="ç¬¦è™Ÿè®€å¿ƒè¡“" description="æˆ‘èƒ½çŒœä¸­ä½ å¿ƒä¸­çš„ç¬¦è™Ÿ">
  <div class="game-page">
    <a href="/" class="back-link">&larr; è¿”å›éŠæˆ²åˆ—è¡¨</a>
    <h1>ğŸ”® ç¬¦è™Ÿè®€å¿ƒè¡“</h1>
    <div class="game-container" id="game">
      <!-- intro -->
      <div id="stage-intro" class="stage">
        <p class="magician-line">ã€Œæˆ‘èƒ½é€éæ•¸å­—çš„åŠ›é‡ï¼Œè®€å–ä½ å¿ƒä¸­çš„ç¬¦è™Ÿã€‚<br>æº–å‚™å¥½äº†å—ï¼Ÿã€</p>
        <button id="btn-start">é–‹å§‹é­”è¡“</button>
      </div>

      <!-- step1: think of a number -->
      <div id="stage-step1" class="stage hidden">
        <div class="step-badge">æ­¥é©Ÿ 1 / 3</div>
        <p class="magician-line">ã€Œè«‹åœ¨å¿ƒä¸­æƒ³ä¸€å€‹<strong>å…©ä½æ•¸</strong>ï¼ˆ10 ~ 99ï¼‰ã€‚<br>ä¾‹å¦‚ï¼š73ã€‚ã€</p>
        <button id="btn-step1">æƒ³å¥½äº†</button>
      </div>

      <!-- step2: calculate -->
      <div id="stage-step2" class="stage hidden">
        <div class="step-badge">æ­¥é©Ÿ 2 / 3</div>
        <p class="magician-line">ã€Œç¾åœ¨æŠŠé€™å€‹æ•¸å­—çš„<strong>åä½æ•¸å’Œå€‹ä½æ•¸ç›¸åŠ </strong>ï¼Œ<br>ç„¶å¾Œç”¨<strong>åŸæœ¬çš„æ•¸å­—æ¸›æ‰é€™å€‹å’Œ</strong>ã€‚<br><br>ä¾‹å¦‚ï¼š73 â†’ 7 + 3 = 10 â†’ 73 - 10 = <strong>63</strong>ã€</p>
        <button id="btn-step2">ç®—å¥½äº†</button>
      </div>

      <!-- step3: find symbol -->
      <div id="stage-step3" class="stage hidden">
        <div class="step-badge">æ­¥é©Ÿ 3 / 3</div>
        <p class="magician-line">ã€Œåœ¨ä¸‹æ–¹çš„è¡¨æ ¼ä¸­æ‰¾åˆ°ä½ ç®—å‡ºçš„æ•¸å­—ï¼Œ<br>è¨˜ä½å®ƒæ—é‚Šçš„ç¬¦è™Ÿã€‚ã€</p>
        <div id="symbol-table" class="symbol-table"></div>
        <button id="btn-step3">è¨˜å¥½äº†</button>
      </div>

      <!-- reveal -->
      <div id="stage-reveal" class="stage hidden">
        <p class="magician-line">ã€Œè®“æˆ‘æ„Ÿæ‡‰ä¸€ä¸‹â‹¯â‹¯ã€</p>
        <div class="reveal-symbol" id="reveal-symbol"></div>
        <p class="magician-line">ã€Œä½ å¿ƒä¸­çš„ç¬¦è™Ÿï¼Œæ˜¯é€™å€‹å§ï¼Ÿã€</p>
        <button id="btn-restart">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Pool of interesting symbols to randomly pick from each round
  const SYMBOL_POOL = [
    'â˜€', 'â˜', 'â˜…', 'â˜¾', 'â™¬', 'âš¡', 'âœ¿', 'âš˜', 'â˜¯', 'âŠ•',
    'â–³', 'â—‡', 'â¬¡', 'âŠ—', 'âŒ˜', 'â˜„', 'â™', 'âš›', 'âœ¦', 'â£',
    'âŸ', 'â—ˆ', 'âŠ™', 'â™»', 'â˜¸', 'âšœ', 'âœª', 'âš', 'â—‰', 'âˆ',
  ];

  function shuffle<T>(arr: T[]): T[] {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateSymbolMap(): { map: Record<number, string>; answer: string } {
    // The secret: for any two-digit number n, n - (sum of digits) is always a multiple of 9
    // Multiples of 9 from 0..99: 0, 9, 18, 27, 36, 45, 54, 63, 72, 81
    const multOf9 = [0, 9, 18, 27, 36, 45, 54, 63, 72, 81];

    // Pick random symbols for this round
    const shuffled = shuffle(SYMBOL_POOL);
    const answer = shuffled[0]; // The magic symbol for all multiples of 9

    const map: Record<number, string> = {};

    // Assign random symbols to all numbers 0-99
    let symbolIdx = 1;
    for (let i = 0; i <= 99; i++) {
      if (multOf9.includes(i)) {
        map[i] = answer;
      } else {
        map[i] = shuffled[symbolIdx % shuffled.length];
        symbolIdx++;
        // Make sure no accidental duplicates with the answer for adjacent numbers
        if (map[i] === answer) {
          symbolIdx++;
          map[i] = shuffled[symbolIdx % shuffled.length];
        }
      }
    }

    return { map, answer };
  }

  // DOM
  const stages = {
    intro: document.getElementById('stage-intro')!,
    step1: document.getElementById('stage-step1')!,
    step2: document.getElementById('stage-step2')!,
    step3: document.getElementById('stage-step3')!,
    reveal: document.getElementById('stage-reveal')!,
  };

  const symbolTableEl = document.getElementById('symbol-table')!;
  const revealSymbolEl = document.getElementById('reveal-symbol')!;

  let currentAnswer = '';

  function showStage(name: keyof typeof stages) {
    for (const [key, el] of Object.entries(stages)) {
      el.classList.toggle('hidden', key !== name);
    }
  }

  function renderTable(map: Record<number, string>) {
    symbolTableEl.innerHTML = '';
    const table = document.createElement('div');
    table.className = 'symbol-grid';

    for (let i = 0; i <= 99; i++) {
      const cell = document.createElement('div');
      cell.className = 'symbol-cell';
      cell.innerHTML = `<span class="cell-number">${i}</span><span class="cell-symbol">${map[i]}</span>`;
      table.appendChild(cell);
    }

    symbolTableEl.appendChild(table);
  }

  function startGame() {
    const { map, answer } = generateSymbolMap();
    currentAnswer = answer;
    renderTable(map);
    showStage('step1');
  }

  function revealAnswer() {
    revealSymbolEl.textContent = currentAnswer;
    revealSymbolEl.classList.remove('pop');
    void revealSymbolEl.offsetWidth; // force reflow
    revealSymbolEl.classList.add('pop');
    showStage('reveal');
  }

  document.getElementById('btn-start')!.addEventListener('click', startGame);
  document.getElementById('btn-step1')!.addEventListener('click', () => showStage('step2'));
  document.getElementById('btn-step2')!.addEventListener('click', () => showStage('step3'));
  document.getElementById('btn-step3')!.addEventListener('click', revealAnswer);
  document.getElementById('btn-restart')!.addEventListener('click', startGame);
</script>

<style is:global>
  .game-page {
    max-width: 800px;
    margin: 0 auto;
  }

  .back-link {
    color: #aaa;
    text-decoration: none;
    font-size: 0.9rem;
    display: inline-block;
    margin-bottom: 1rem;
  }

  .back-link:hover {
    color: #fff;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 1.5rem;
  }

  .game-container {
    background: #1a1a2e;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
  }

  .stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
  }

  .hidden {
    display: none !important;
  }

  .step-badge {
    background: #2a2a4a;
    color: #aaa;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
  }

  .magician-line {
    font-size: 1.1rem;
    color: #ddd;
    line-height: 1.8;
    max-width: 520px;
  }

  button {
    background: #4a4a8a;
    color: #fff;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover {
    background: #5a5a9a;
  }

  /* Symbol table */
  .symbol-table {
    width: 100%;
    overflow-x: auto;
  }

  .symbol-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 4px;
    max-width: 600px;
    margin: 0 auto;
  }

  .symbol-cell {
    background: #222240;
    border-radius: 6px;
    padding: 4px 2px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    transition: background 0.2s;
  }

  .symbol-cell:hover {
    background: #2a2a5a;
  }

  .cell-number {
    font-size: 0.7rem;
    color: #888;
  }

  .cell-symbol {
    font-size: 1.1rem;
  }

  /* Reveal */
  .reveal-symbol {
    font-size: 5rem;
    line-height: 1;
    padding: 1rem;
  }

  .reveal-symbol.pop {
    animation: popIn 0.5s ease-out;
  }

  @keyframes popIn {
    0% { transform: scale(0); opacity: 0; }
    60% { transform: scale(1.3); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 480px) {
    .symbol-grid {
      grid-template-columns: repeat(5, 1fr);
      gap: 3px;
    }

    .cell-symbol {
      font-size: 1rem;
    }

    .reveal-symbol {
      font-size: 4rem;
    }
  }
</style>
