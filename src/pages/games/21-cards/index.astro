---
import BaseLayout from '../../../layouts/BaseLayout.astro';
---

<BaseLayout title="21 å¼µç‰Œé­”è¡“" description="å¾ 21 å¼µç‰Œä¸­æ‰¾å‡ºä½ å¿ƒä¸­çš„é‚£å¼µ">
  <div class="game-page">
    <a href="/" class="back-link">&larr; è¿”å›éŠæˆ²åˆ—è¡¨</a>
    <h1>ğŸ´ 21 å¼µç‰Œé­”è¡“</h1>
    <div class="game-container" id="game">
      <!-- intro -->
      <div id="stage-intro" class="stage">
        <p class="magician-line">ã€Œæˆ‘å°‡å±•ç¤º 21 å¼µç‰Œï¼Œåˆ†æˆä¸‰æ’ã€‚<br>è«‹ä½ åœ¨å¿ƒä¸­é¸ä¸€å¼µç‰Œï¼Œç„¶å¾Œå‘Šè¨´æˆ‘å®ƒåœ¨å“ªä¸€æ’ã€‚<br>åªè¦ä¸‰å€‹å›åˆï¼Œæˆ‘å°±èƒ½æ‰¾åˆ°å®ƒã€‚ã€</p>
        <button id="btn-start" class="primary-btn">é–‹å§‹é­”è¡“</button>
      </div>

      <!-- pick column -->
      <div id="stage-pick" class="stage hidden">
        <div class="round-badge" id="round-badge">ç¬¬ 1 å›åˆï¼ˆå…± 3 å›åˆï¼‰</div>
        <p class="magician-line">ã€Œä½ é¸çš„ç‰Œåœ¨å“ªä¸€æ’ï¼Ÿé»é¸ä¸‹æ–¹çš„æ’ã€‚ã€</p>
        <div class="columns-wrapper">
          <div class="column" id="col-wrap-0">
            <div class="col-cards" id="col-0"></div>
            <button class="col-btn" data-col="0">é¸é€™æ’</button>
          </div>
          <div class="column" id="col-wrap-1">
            <div class="col-cards" id="col-1"></div>
            <button class="col-btn" data-col="1">é¸é€™æ’</button>
          </div>
          <div class="column" id="col-wrap-2">
            <div class="col-cards" id="col-2"></div>
            <button class="col-btn" data-col="2">é¸é€™æ’</button>
          </div>
        </div>
      </div>

      <!-- reveal -->
      <div id="stage-reveal" class="stage hidden">
        <p class="magician-line">ã€Œè®“æˆ‘æ„Ÿæ‡‰ä¸€ä¸‹â‹¯â‹¯<br>ä½ é¸çš„ç‰Œï¼Œæ˜¯é€™å¼µå§ï¼Ÿã€</p>
        <div id="reveal-card" class="reveal-card-wrapper"></div>
        <button id="btn-restart" class="primary-btn">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'] as const;
  const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'] as const;

  type Card = { suit: typeof SUITS[number]; rank: typeof RANKS[number] };

  function buildDeck(): Card[] {
    const deck: Card[] = [];
    for (const suit of SUITS) {
      for (const rank of RANKS) {
        deck.push({ suit, rank });
      }
    }
    return deck;
  }

  function shuffle<T>(arr: T[]): T[] {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function isRed(suit: string): boolean {
    return suit === 'â™¥' || suit === 'â™¦';
  }

  /** Compact card chip for the 3-column grid */
  function renderChip(card: Card, delay: number): HTMLElement {
    const el = document.createElement('div');
    el.className = 'chip' + (isRed(card.suit) ? ' chip-red' : ' chip-black');
    el.style.animationDelay = `${delay * 0.04}s`;
    el.innerHTML = `<span class="chip-rank">${card.rank}</span><span class="chip-suit">${card.suit}</span>`;
    return el;
  }

  /** Large card for the final reveal */
  function renderRevealCard(card: Card): HTMLElement {
    const el = document.createElement('div');
    const red = isRed(card.suit);
    el.className = 'reveal-card' + (red ? ' reveal-red' : '');
    el.innerHTML = `
      <div class="rv-tl"><div class="rv-rank">${card.rank}</div><div class="rv-suit">${card.suit}</div></div>
      <div class="rv-center">${card.suit}</div>
      <div class="rv-br"><div class="rv-rank">${card.rank}</div><div class="rv-suit">${card.suit}</div></div>
    `;
    return el;
  }

  // DOM
  const stages = {
    intro: document.getElementById('stage-intro')!,
    pick: document.getElementById('stage-pick')!,
    reveal: document.getElementById('stage-reveal')!,
  };

  const colEls = [
    document.getElementById('col-0')!,
    document.getElementById('col-1')!,
    document.getElementById('col-2')!,
  ];
  const colWraps = [
    document.getElementById('col-wrap-0')!,
    document.getElementById('col-wrap-1')!,
    document.getElementById('col-wrap-2')!,
  ];
  const roundBadge = document.getElementById('round-badge')!;
  const revealCardEl = document.getElementById('reveal-card')!;

  let cards: Card[] = [];
  let round = 0;

  function showStage(name: keyof typeof stages) {
    for (const [key, el] of Object.entries(stages)) {
      el.classList.toggle('hidden', key !== name);
    }
  }

  function dealToColumns(): Card[][] {
    const cols: Card[][] = [[], [], []];
    for (let i = 0; i < 21; i++) {
      cols[i % 3].push(cards[i]);
    }
    return cols;
  }

  function renderColumns(cols: Card[][]) {
    for (let c = 0; c < 3; c++) {
      colEls[c].innerHTML = '';
      cols[c].forEach((card, i) => {
        colEls[c].appendChild(renderChip(card, c * 7 + i));
      });
      colWraps[c].classList.remove('col-selected');
    }
  }

  function startGame() {
    cards = shuffle(buildDeck()).slice(0, 21);
    round = 0;
    nextRound();
  }

  function nextRound() {
    round++;
    roundBadge.textContent = `ç¬¬ ${round} å›åˆï¼ˆå…± 3 å›åˆï¼‰`;
    const cols = dealToColumns();
    renderColumns(cols);
    showStage('pick');
  }

  function pickColumn(chosenCol: number) {
    // Highlight chosen column briefly
    colWraps[chosenCol].classList.add('col-selected');

    setTimeout(() => {
      const cols = dealToColumns();
      const left = (chosenCol + 1) % 3;
      const right = (chosenCol + 2) % 3;
      cards = [...cols[left], ...cols[chosenCol], ...cols[right]];

      if (round >= 3) {
        revealCardEl.innerHTML = '';
        revealCardEl.appendChild(renderRevealCard(cards[10]));
        showStage('reveal');
      } else {
        nextRound();
      }
    }, 350);
  }

  document.getElementById('btn-start')!.addEventListener('click', startGame);
  document.getElementById('btn-restart')!.addEventListener('click', startGame);

  document.querySelectorAll('.col-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const col = parseInt((btn as HTMLElement).dataset.col!, 10);
      pickColumn(col);
    });
  });
</script>

<style is:global>
  .game-page {
    max-width: 820px;
    margin: 0 auto;
  }

  .back-link {
    color: #aaa;
    text-decoration: none;
    font-size: 0.9rem;
    display: inline-block;
    margin-bottom: 1rem;
  }

  .back-link:hover { color: #fff; }

  h1 {
    font-size: 2rem;
    margin-bottom: 1.5rem;
  }

  .game-container {
    background: #1a1a2e;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 2rem 1.5rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
  }

  .stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
  }

  .hidden { display: none !important; }

  .round-badge {
    background: #2a2a4a;
    color: #aaa;
    padding: 0.3rem 0.85rem;
    border-radius: 999px;
    font-size: 0.8rem;
    letter-spacing: 0.03em;
  }

  .magician-line {
    font-size: 1.1rem;
    color: #ddd;
    line-height: 1.8;
    max-width: 520px;
  }

  .primary-btn {
    background: #4a4a8a;
    color: #fff;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .primary-btn:hover { background: #5a5a9a; }

  /* ---- 3-column grid ---- */
  .columns-wrapper {
    display: flex;
    gap: 14px;
    width: 100%;
    justify-content: center;
  }

  .column {
    flex: 1;
    max-width: 220px;
    background: #16162a;
    border: 2px solid #2a2a3e;
    border-radius: 10px;
    padding: 10px 8px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: border-color 0.25s, box-shadow 0.25s;
  }

  .column:hover {
    border-color: #4a4a7a;
  }

  .col-selected {
    border-color: #7a7aff !important;
    box-shadow: 0 0 16px rgba(122, 122, 255, 0.25);
  }

  .col-cards {
    display: flex;
    flex-direction: column;
    gap: 5px;
    width: 100%;
  }

  .col-btn {
    background: #3a3a6e;
    color: #ccc;
    border: none;
    padding: 0.45rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    width: 100%;
  }

  .col-btn:hover {
    background: #5555aa;
    color: #fff;
  }

  /* ---- Card chip (compact) ---- */
  .chip {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    background: #fff;
    border-radius: 6px;
    padding: 6px 0;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.18);
    animation: chipIn 0.3s ease-out both;
    user-select: none;
  }

  .chip-black {
    color: #2a2a2a;
  }

  .chip-red {
    color: #d33;
  }

  .chip-rank {
    font-size: 1rem;
  }

  .chip-suit {
    font-size: 0.85rem;
  }

  @keyframes chipIn {
    from { opacity: 0; transform: translateY(-6px) scale(0.92); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* ---- Reveal card (large, styled) ---- */
  .reveal-card-wrapper {
    display: flex;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .reveal-card {
    width: 130px;
    height: 185px;
    background: #fff;
    border-radius: 10px;
    position: relative;
    box-shadow: 0 4px 24px rgba(0,0,0,0.35);
    color: #2a2a2a;
    animation: revealPop 0.6s ease-out;
  }

  .reveal-card.reveal-red {
    color: #d33;
  }

  .rv-tl, .rv-br {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1.1;
    font-weight: 700;
  }

  .rv-tl {
    top: 8px;
    left: 10px;
  }

  .rv-br {
    bottom: 8px;
    right: 10px;
    transform: rotate(180deg);
  }

  .rv-rank {
    font-size: 1.15rem;
  }

  .rv-suit {
    font-size: 0.8rem;
  }

  .rv-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3.2rem;
  }

  @keyframes revealPop {
    0%  { opacity: 0; transform: scale(0) rotateY(180deg); }
    55% { transform: scale(1.08) rotateY(0); }
    100%{ opacity: 1; transform: scale(1) rotateY(0); }
  }

  /* ---- Responsive ---- */
  @media (max-width: 560px) {
    .game-container {
      padding: 1.25rem 0.75rem;
    }

    .columns-wrapper {
      gap: 8px;
    }

    .column {
      padding: 8px 5px 10px;
    }

    .chip {
      font-size: 0.85rem;
      padding: 5px 0;
    }

    .chip-rank { font-size: 0.9rem; }
    .chip-suit { font-size: 0.75rem; }

    .col-btn {
      font-size: 0.78rem;
      padding: 0.4rem 0.5rem;
    }

    .reveal-card {
      width: 110px;
      height: 155px;
    }

    .rv-center {
      font-size: 2.6rem;
    }
  }
</style>
